<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Road-Trip Rally üöó</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<style>
  :root{ --bg:#0b0f14; --ink:#e6eefc; --ink-d:#a8b3cd; --accent:#7dd3fc; --glass: rgba(255,255,255,0.07); }
  html,body{height:100%;margin:0;background:radial-gradient(1200px 700px at 70% -10%, #1b2235 0%, #0f1422 45%, var(--bg) 100%);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1100px;margin:0 auto;padding:clamp(12px,3vmin,32px);}
  h1{font-size:clamp(24px,3.2vmax,40px);margin:16px 0 8px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,0.06),rgba(255,255,255,0.03));border:1px solid rgba(255,255,255,0.08);box-shadow:0 10px 40px rgba(0,0,0,0.35);border-radius:20px;padding:18px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .btn{background:var(--glass);border:1px solid rgba(255,255,255,0.15);border-radius:12px;padding:10px 14px;color:var(--ink);cursor:pointer;user-select:none}
  .btn.primary{background:linear-gradient(180deg,var(--accent),#4fb9ec);color:#071521;border:none;font-weight:700}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  input, .code{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.15);background:rgba(255,255,255,0.06);color:var(--ink)}
  input::placeholder{color:var(--ink-d)}
  .lobbylist{display:flex;flex-wrap:wrap;gap:8px}
  .tag{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.15);background:rgba(255,255,255,0.06)}
  canvas{width:100%;height:70vh;background:linear-gradient(#0a0e17,#0b1726 30%, #0c1a2b);}
  .hud{position:fixed;inset:auto 0 16px 0;display:flex;justify-content:center;pointer-events:none}
  .hud .bar{display:flex;gap:8px;padding:10px 14px;background:rgba(0,0,0,0.35);backdrop-filter:blur(6px);border-radius:14px;border:1px solid rgba(255,255,255,0.15)}
  .stat{min-width:80px;text-align:center}
  .fuel{width:160px;height:10px;background:rgba(255,255,255,0.12);border-radius:999px;overflow:hidden}
  .fuel > div{height:100%;background:linear-gradient(90deg,#4ade80,#facc15,#ef4444);width:50%}
  .corner{position:fixed;top:12px;right:12px;display:flex;gap:8px}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;background:rgba(0,0,0,0.35);border-radius:999px;border:1px solid rgba(255,255,255,0.15)}
  .status{position:fixed;left:12px;top:12px;padding:8px 12px;border-radius:10px;background:rgba(0,0,0,0.45);border:1px solid rgba(255,255,255,0.15)}
  .minipad{position:fixed;left:12px;bottom:12px;display:none;gap:10px;flex-direction:column}
  .padrow{display:flex;gap:10px;justify-content:center}
  .padbtn{width:64px;height:64px;border-radius:50%;background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;font-weight:800;user-select:none}
  @media (max-width: 820px){ .minipad{display:flex} canvas{height:64vh} }
</style>
</head>
<body>
<div class="wrap">
  <h1>Road-Trip Rally <span style="color:#9fb5d9">‚Ä¢ Multiplayer Prototype</span></h1>

  <div id="screen-home" class="card">
    <div class="row" style="align-items:flex-end">
      <div style="flex:1;min-width:260px">
        <label>Name</label>
        <input id="name" placeholder="Your display name" />
      </div>
      <div>
        <label>Color</label>
        <input id="color" type="color" value="#7dd3fc" />
      </div>
    </div>
    <div style="height:12px"></div>
    <div class="row">
      <div class="card" style="flex:1">
        <h3>Create Room</h3>
        <button id="btnCreate" class="btn primary">Create</button>
      </div>
      <div class="card" style="flex:2">
        <h3>Join Room</h3>
        <div class="row">
          <input id="joinCode" placeholder="Enter code (e.g., 7Q2K8M)" />
          <button id="btnJoin" class="btn">Join</button>
        </div>
      </div>
    </div>
    <div style="height:8px"></div>
    <div style="color:#a8b3cd">Controls: <b>W / ‚Üë</b> throttle, <b>S / ‚Üì</b> brake, <b>A/D / ‚Üê/‚Üí</b> steer, <b>F</b> refuel at ‚õΩ.</div>
  </div>

  <div id="screen-lobby" class="card" style="display:none">
    <div class="row" style="align-items:center;justify-content:space-between">
      <div>Room Code: <span id="roomCode" class="code" style="font-weight:800;letter-spacing:2px;padding:8px 10px"></span></div>
      <div class="row">
        <button id="btnReady" class="btn">Ready</button>
        <button id="btnStart" class="btn primary" title="Host can start">Start</button>
      </div>
    </div>
    <div style="height:12px"></div>
    <div class="lobbylist" id="lobbyList"></div>
  </div>

  <div id="screen-game" class="card" style="display:none">
    <canvas id="game" width="1100" height="640"></canvas>
    <div class="hud">
      <div class="bar">
        <div class="stat">Speed<br><b id="uiSpeed">0</b> m/s</div>
        <div class="stat">Distance<br><b id="uiDist">0</b> m</div>
        <div class="stat">Fuel<br><div class="fuel"><div id="fuelFill"></div></div></div>
        <div class="stat">Room<br><b id="uiRoom">‚Äî</b></div>
      </div>
    </div>
    <div class="corner">
      <span class="pill">Ping: <b id="uiPing">‚Äî</b> ms</span>
      <span class="pill">Players: <b id="uiPCount">‚Äî</b></span>
    </div>
  </div>
</div>

<div id="statusBadge" class="status" style="display:none">Connecting‚Ä¶</div>

<!-- Mobile mini pad -->
<div class="minipad" id="pad">
  <div class="padrow">
    <div class="padbtn" data-steer="-1">‚óÄ</div>
    <div class="padbtn" data-throttle="1">‚ñ≤</div>
    <div class="padbtn" data-steer="1">‚ñ∂</div>
  </div>
  <div class="padrow">
    <div class="padbtn" data-brake="1">‚ñº</div>
    <div class="padbtn" data-refuel="1">‚õΩ</div>
  </div>
</div>

<!-- Socket.IO client from CDN (works on GitHub Pages) -->
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
<!-- Optional: set a remote server when hosting this file on Pages
<script>window.SOCKET_URL="https://your-rally-server.example.com";</script>
-->

<script>
/* ===========================
   Client for Road-Trip Rally
   =========================== */

const $ = (q)=>document.querySelector(q);
let socket, connected = false, offline = false, offlineTimer;

// --- UI/state ---
const S = { me:null, isHost:false, code:null, seed:0, phase:"lobby",
  players:new Map(), input:{throttle:0,brake:0,steer:0,refuel:false}, interp:new Map(), ping:"‚Äî" };
const $home = $("#screen-home"), $lobby = $("#screen-lobby"), $game = $("#screen-game");
const $roomCode=$("#roomCode"), $lobbyList=$("#lobbyList");
const $uiSpeed=$("#uiSpeed"), $uiDist=$("#uiDist"), $uiRoom=$("#uiRoom"), $uiPing=$("#uiPing"), $uiPCount=$("#uiPCount");
const $fuelFill=$("#fuelFill"), $status=$("#statusBadge");

function show(id){ $home.style.display=id==="home"?"block":"none"; $lobby.style.display=id==="lobby"?"block":"none"; $game.style.display=id==="game"?"block":"none"; }
function setStatus(txt, show=true){ $status.textContent = txt; $status.style.display = show?"block":"none"; }

// --- connect socket ---
function connectSocket() {
  try {
    // If you add window.SOCKET_URL above, it will connect there; otherwise try same-origin.
    socket = window.SOCKET_URL ? io(window.SOCKET_URL, { transports:["websocket"] }) : io({ transports:["websocket"] });
  } catch (e) { enableOffline("Socket failed ‚Äî Solo Mode"); return; }

  setStatus("Connecting‚Ä¶", true);
  offlineTimer = setTimeout(()=>{ if (!connected) enableOffline("Server not found ‚Äî Solo Mode"); }, 3000);

  socket.on("connect", () => {
    connected = true; clearTimeout(offlineTimer);
    setStatus("Connected ‚Äî Multiplayer", true); setTimeout(()=>setStatus("", false), 1000);
  });
  socket.on("connect_error", () => { if (!offline) enableOffline("Connection error ‚Äî Solo Mode"); });
  socket.on("disconnect", () => { if (!offline) enableOffline("Disconnected ‚Äî Solo Mode"); });

  socket.on("errorMsg", (m)=>alert(m));
  socket.on("joined", (data)=>{
    S.code=data.code; S.seed=data.seed; S.phase=data.phase; $roomCode.textContent=data.code;
    S.me=data.playerId; S.isHost = !!(data.players.find(p=>p.id===S.me)?.isHost);
    $("#btnStart").style.display = S.isHost ? "inline-flex" : "none";
    updateLobbyList(data.players); $uiRoom.textContent = S.code; show("lobby");
  });
  socket.on("lobby", (data)=>{
    S.seed=data.seed; S.phase=data.phase; S.isHost = !!(data.players.find(p=>p.id===S.me)?.isHost);
    $("#btnStart").style.display = S.isHost ? "inline-flex" : "none";
    updateLobbyList(data.players);
  });
  socket.on("start", ({seed})=>{ S.phase="running"; S.seed=seed; show("game"); });
  socket.on("state", (payload)=>{
    S.phase = payload.phase;
    const ids = new Set();
    payload.players.forEach(p=>{
      ids.add(p.id);
      const prev = S.players.get(p.id);
      S.players.set(p.id, p);
      if (p.id !== S.me) {
        const t0 = performance.now(), t1 = t0 + 50;
        S.interp.set(p.id, { from: prev || p, to: p, t0, t1 });
      }
    });
    for (const id of Array.from(S.players.keys())) if (!ids.has(id)) { S.players.delete(id); S.interp.delete(id); }
    $uiPCount.textContent = S.players.size;
  });

  // custom ping for HUD
  setInterval(()=>{ if (socket && socket.connected) socket.emit("pingCheck", { t: performance.now() }); }, 2000);
  socket.on("pong", (d)=>{ S.ping = Math.round(performance.now() - d.t); $uiPing.textContent = S.ping; });
}

function enableOffline(reason){
  offline = true; setStatus(reason, true);
  if (getComputedStyle($home).display !== "none" || getComputedStyle($lobby).display !== "none") { show("game"); $uiRoom.textContent="SOLO"; }
  if (!S.seed) S.seed = (Math.random()*1e9)|0;
  if (!S.players.has("local")) {
    S.me = "local";
    S.players.set("local", { id:"local", name:"Driver", color:"#7dd3fc", x:0, y:0, angle:0, speed:0, fuel:100, maxFuel:100, distance:0 });
  }
  startSoloTick();
}

// --- UI actions ---
$("#btnCreate").onclick = () => socket?.emit("createRoom", { name: $("#name").value, color: $("#color").value });
$("#btnJoin").onclick   = () => socket?.emit("joinRoom", { code: $("#joinCode").value, name: $("#name").value, color: $("#color").value });
$("#btnReady").onclick  = () => { S.meReady = !S.meReady; socket?.emit("setReady", S.meReady); $("#btnReady").textContent = S.meReady ? "Ready ‚úì" : "Ready"; };
$("#btnStart").onclick  = () => socket?.emit("startGame");

// Mobile mini pad
for (const el of document.querySelectorAll(".padbtn")) {
  let down = false;
  el.addEventListener("pointerdown",(e)=>{e.preventDefault();down=true;setFromPad(el,true);});
  el.addEventListener("pointerup",()=>{down=false;setFromPad(el,false);});
  el.addEventListener("pointerleave",()=>{if(down){down=false;setFromPad(el,false);}});
}
function setFromPad(el, active){
  if (el.dataset.throttle) S.input.throttle = active ? 1 : 0;
  if (el.dataset.brake)    S.input.brake = active ? 1 : 0;
  if (el.dataset.steer)    S.input.steer = active ? Number(el.dataset.steer) : 0;
  if (el.dataset.refuel)   S.input.refuel = !!active;
}

// --- input ---
const keys = {};
addEventListener("keydown",(e)=>{ keys[e.key.toLowerCase()] = true; });
addEventListener("keyup",(e)=>{ keys[e.key.toLowerCase()] = false; });
function updateInput(){ S.input.throttle=(keys["w"]||keys["arrowup"])?1:0; S.input.brake=(keys["s"]||keys["arrowdown"])?1:0; S.input.steer=(keys["a"]||keys["arrowleft"])?-1:(keys["d"]||keys["arrowright"])?1:0; S.input.refuel=!!keys["f"]; }

// --- world helpers (mirror server) ---
function noise1(seed, y){ const y0=Math.floor(y),y1=y0+1,t=y-y0; const rnd=(n)=>{const x=Math.sin((n+seed)*12345.678)*43758.5453;return x-Math.floor(x)}; const smooth=t*t*(3-2*t); return rnd(y0)*(1-smooth)+rnd(y1)*smooth; }
function roadCenterX(seed,yMeters){ return (noise1(seed,yMeters*0.0025)*2-1)*25; }
function poiForY(seed,yMeters){ const SEG=800,k=Math.floor(yMeters/SEG),r=noise1(seed+9999,k); let type="none"; if(r<0.22)type="gas"; else if(r<0.38)type="hotel"; else if(r<0.54)type="store"; else if(r<0.68)type="town"; const cx=roadCenterX(seed,k*SEG+SEG*0.5),side=(r<0.5?-1:1); return {k,type,x:cx+side*(7+10),y:k*SEG+SEG*0.5,radius:type==="town"?22:10}; }

// --- render ---
const canvas=document.getElementById("game"); const ctx=canvas.getContext("2d");
function resize(){ const r=canvas.getBoundingClientRect(); canvas.width=Math.floor(r.width); canvas.height=Math.floor(r.height); }
addEventListener("resize", resize); resize();
function lerp(a,b,t){ return a + (b-a)*t; }
function roundedRect(ctx,x,y,w,h,r,fill=true,stroke=false){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); if(fill)ctx.fill(); if(stroke)ctx.stroke(); }
function lighten(hex,amt){ const c=parseInt(hex.slice(1),16); let r=(c>>16)+amt,g=((c>>8)&255)+amt,b=(c&255)+amt; r=Math.min(255,Math.max(0,r)); g=Math.min(255,Math.max(0,g)); b=Math.min(255,Math.max(0,b)); return "#"+((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1); }
function darken(hex,amt){ return lighten(hex,-amt); }
function carSprite(ctx,color){ const grd=ctx.createLinearGradient(0,-20,0,20); grd.addColorStop(0,lighten(color,20)); grd.addColorStop(1,darken(color,10)); ctx.fillStyle=grd; roundedRect(ctx,-12,-22,24,44,8,true,false); ctx.fillStyle="rgba(200,230,255,0.9)"; roundedRect(ctx,-9,-10,18,14,4,true,false); ctx.fillStyle="rgba(0,0,0,0.25)"; roundedRect(ctx,-12,16,24,4,2,true,false); ctx.fillStyle="#ffd166"; ctx.fillRect(-10,-22,6,3); ctx.fillRect(4,-22,6,3); ctx.fillStyle="#ef476f"; ctx.fillRect(-10,19,6,3); ctx.fillRect(4,19,6,3); }
function house(ctx,x,y,w){ ctx.save(); ctx.translate(x,y); ctx.fillStyle="#7dd3fc"; roundedRect(ctx,-w*0.4,-16,w*0.8,26,6,true,false); ctx.fillStyle="rgba(0,0,0,0.35)"; ctx.beginPath(); ctx.moveTo(-w*0.45,-16); ctx.lineTo(0,-28); ctx.lineTo(w*0.45,-16); ctx.closePath(); ctx.fill(); ctx.restore(); }
function town(ctx,x,y,w){ ctx.save(); ctx.translate(x,y); for(let i=0;i<4;i++){ ctx.fillStyle=i%2?"#9dd6b9":"#f6a93b"; roundedRect(ctx,-w*0.6+i*(w*0.35),-18-i*2,w*0.28,26+i*3,4,true,false); } ctx.restore(); }

function draw(){
  updateInput();

  const me=S.players.get(S.me);
  let camX=0,camY=0,myFuel=0,mySpeed=0,myDist=0;
  if(me){ camX=me.x; camY=me.y; myFuel=me.fuel; mySpeed=me.speed; myDist=me.distance; }

  ctx.clearRect(0,0,canvas.width,canvas.height);
  const g=ctx.createLinearGradient(0,0,0,canvas.height); g.addColorStop(0,"#0a0e17"); g.addColorStop(1,"#09121f"); ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width,canvas.height);

  const m2px=8, cx=canvas.width/2, cy=canvas.height*0.6, roadHalf=7;

  // road band
  ctx.beginPath();
  for(let i=-60;i<=60;i++){
    const y=camY+i*4, center=roadCenterX(S.seed,y);
    const sx=cx+(center-camX)*m2px, sy=cy+(camY-y)*m2px;
    const left=sx-roadHalf*m2px; if(i===-60) ctx.moveTo(left,sy); else ctx.lineTo(left,sy);
  }
  for(let i=60;i>=-60;i--){
    const y=camY+i*4, center=roadCenterX(S.seed,y);
    const sx=cx+(center-camX)*m2px, sy=cy+(camY-y)*m2px;
    const right=sx+roadHalf*m2px; ctx.lineTo(right,sy);
  }
  ctx.closePath(); ctx.shadowColor="rgba(0,0,0,0.6)"; ctx.shadowBlur=10; ctx.fillStyle="#2d3546"; ctx.fill();

  // lane markings
  ctx.shadowBlur=0; ctx.lineWidth=2; ctx.setLineDash([10,12]); ctx.strokeStyle="rgba(250,250,200,0.8)";
  ctx.beginPath();
  for(let i=-60;i<=60;i++){
    const y=camY+i*10, center=roadCenterX(S.seed,y);
    const sx=cx+(center-camX)*m2px, sy=cy+(camY-y)*m2px;
    if(i===-60) ctx.moveTo(sx,sy); else ctx.lineTo(sx,sy);
  }
  ctx.stroke(); ctx.setLineDash([]);

  // edges
  ctx.lineWidth=3; ctx.strokeStyle="rgba(255,255,255,0.35)";
  ctx.beginPath();
  for(let i=-60;i<=60;i++){
    const y=camY+i*6, center=roadCenterX(S.seed,y);
    const sx=cx+(center-camX)*m2px, sy=cy+(camY-y)*m2px;
    ctx.lineTo(sx-roadHalf*m2px, sy);
  }
  ctx.stroke();
  ctx.beginPath();
  for(let i=-60;i<=60;i++){
    const y=camY+i*6, center=roadCenterX(S.seed,y);
    const sx=cx+(center-camX)*m2px, sy=cy+(camY-y)*m2px;
    ctx.lineTo(sx+roadHalf*m2px, sy);
  }
  ctx.stroke();

  // POIs
  for(let dk=-4; dk<=6; dk++){
    const poi=poiForY(S.seed, camY + dk*800);
    if(poi.type==="none") continue;
    const sx=cx+(poi.x-camX)*m2px, sy=cy+(camY-poi.y)*m2px;
    if(sy < -200 || sy > canvas.height+200) continue;

    ctx.fillStyle="rgba(0,0,0,0.35)";
    ctx.beginPath(); ctx.ellipse(sx, sy+10, poi.radius*m2px*0.9, 8, 0, 0, Math.PI*2); ctx.fill();

    if (poi.type==="gas" || poi.type==="store") {
      ctx.fillStyle = poi.type==="gas" ? "#3ecf8e" : "#f6a93b";
      ctx.strokeStyle="rgba(255,255,255,0.6)";
      roundedRect(ctx, sx - poi.radius*m2px*0.6, sy - 18, poi.radius*m2px*1.2, 26, 6, true, true);
      ctx.fillStyle="rgba(0,0,0,0.65)"; ctx.font="14px ui-sans-serif"; ctx.textAlign="center";
      ctx.fillText(poi.type==="gas"?"‚õΩ":"üè™", sx, sy);
    } else if (poi.type==="hotel") {
      ctx.fillStyle="#7dd3fc"; house(ctx, sx, sy, poi.radius*m2px*1.1);
    } else if (poi.type==="town") {
      ctx.fillStyle="#a78bfa"; town(ctx, sx, sy, poi.radius*m2px*1.2);
    }
  }

  // players
  for (const [id, pl] of S.players.entries()) {
    let x=pl.x, y=pl.y, angle=pl.angle, col=pl.color||"#fff", name=pl.name||"Driver";
    if (!offline && id !== S.me) {
      const it=S.interp.get(id);
      if(it){ const t=Math.min(1,(performance.now()-it.t0)/(it.t1-it.t0)); x=lerp(it.from.x,it.to.x,t); y=lerp(it.from.y,it.to.y,t); angle=lerp(it.from.angle,it.to.angle,t); }
    }
    const sx=(canvas.width/2)+(x-camX)*m2px, sy=(canvas.height*0.6)+(camY-y)*m2px;

    ctx.fillStyle="rgba(0,0,0,0.45)"; ctx.beginPath(); ctx.ellipse(sx, sy+10, 18, 6, 0, 0, Math.PI*2); ctx.fill();
    ctx.save(); ctx.translate(sx,sy); ctx.rotate(-angle); carSprite(ctx,col); ctx.restore();
    ctx.font="12px ui-sans-serif"; ctx.textAlign="center"; ctx.fillStyle="rgba(255,255,255,0.9)"; ctx.fillText(name, sx, sy-28);
  }

  const mep=me||{speed:0,distance:0,fuel:0};
  $uiSpeed.textContent = Math.max(0, (mep.speed|0));
  $uiDist.textContent  = Math.max(0, (mep.distance|0));
  const pct = Math.max(0, Math.min(1, (mep.fuel||0)/100));
  $fuelFill.style.width = (pct*100) + "%";

  requestAnimationFrame(draw);
}
requestAnimationFrame(draw);

// ---- Solo mode tick (offline fallback) ----
function startSoloTick(){
  const phys = { accel:8, brake:10, baseFriction:0.9, offroadFriction:0.65, maxSpeed:45, turnRate:1.8, fuelBurn:0.015, roadHalfW:7 };
  setInterval(()=>{
    updateInput();
    const p = S.players.get("local"); if(!p) return;

    const cx = roadCenterX(S.seed, p.y);
    const onRoad = Math.abs(p.x - cx) <= phys.roadHalfW;
    const aFwd = S.input.throttle * phys.accel - S.input.brake * phys.brake;
    p.speed += aFwd * (1/20);
    p.speed *= Math.pow(onRoad ? phys.baseFriction : phys.offroadFriction, 1/20);
    if (p.speed > phys.maxSpeed) p.speed = phys.maxSpeed;
    if (p.speed < -10) p.speed = -10;

    const steerFactor = 0.2 + 0.8 * Math.min(Math.abs(p.speed)/phys.maxSpeed, 1);
    p.angle += S.input.steer * phys.turnRate * steerFactor * (1/20);

    const dx = Math.sin(p.angle) * p.speed * (1/20);
    const dy = Math.cos(p.angle) * p.speed * (1/20);
    p.x += dx; p.y += dy; if (dy > 0) p.distance += dy;

    if (S.input.throttle > 0 && p.speed > 0.2) {
      p.fuel -= phys.fuelBurn * S.input.throttle * (onRoad ? 1 : 1.8);
      if (p.fuel < 0) p.fuel = 0;
    }
    if (S.input.refuel && p.fuel < p.maxFuel) {
      const poi = poiForY(S.seed, p.y);
      const dist = Math.hypot(p.x - poi.x, p.y - poi.y);
      if ((poi.type === "gas" || poi.type === "town" || poi.type === "store") && dist <= poi.radius + 3) {
        p.fuel += 30 * (1/20);
        if (p.fuel > p.maxFuel) p.fuel = p.maxFuel;
      }
    }
    if (p.fuel <= 0 && p.speed > 0) p.speed *= Math.pow(0.5, 1/20);
  }, 1000/20);
}

// --- lobby UI ---
function updateLobbyList(players){
  $lobbyList.innerHTML = "";
  players.forEach(p=>{
    const el = document.createElement("div");
    el.className = "tag";
    el.innerHTML = `<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${p.color};margin-right:8px"></span>
                    <b>${escapeHtml(p.name)}</b>${p.isHost ? " (Host)" : ""} ‚Äî ${p.ready?"‚úÖ Ready":"‚è≥ Not ready"}`;
    $lobbyList.appendChild(el);
  });
}
function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }

// boot
show("home");
connectSocket();
addEventListener("orientationchange", ()=>setTimeout(resize, 150));
</script>
</body>
</html>
